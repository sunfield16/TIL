## awk
awkは主にテキストの処理を行うのに使われる。  
正確にはスクリプト言語であり、元々はsedやgrepなどのテキスト処理コマンドに  
演算の機能をつけた拡張ツールとしてUNIX上で開発された。

他のスクリプト言語ほどの機能はないが、シンプルな構文でシェルスクリプトに組み込みやすく、  
覚えることがあまり多くないため習得が比較的簡単。  

## 基本の使い方
```bash
awk [オプション] [スクリプト] [テキストファイル]
```

シェルスクリプトで使う場合はこのようなイメージ。
```bash
# 「$0」は読み込んだ1行分のテキストを表す
echo "hogehoge" | awk '{ print "Hello, " $0 }'

# 出力
# Hello, hogehoge
```

## オプション
### 読み込んだ1行分のテキストを分割して扱う
`-F`で、指定した1文字でテキストを分割することができる。
`$1, $2, $3 ...`で分割したテキストをそれぞれ取得可能。（詳しくは後述）

```bash
# 「:」で分割して、その中の2番目のテキストを表示
echo "1:2,3:4" | awk -F ':' '{ print $2 }'

# 出力
# 2,3
```

`[]`で囲うことで複数の文字を指定できる。    
（囲んだ文字それぞれで分割される）
```bash
# 「:」「,」で分割して、その中の2番目のテキストを表示
echo "1:2,3:4" | awk -F '[:,]' '{ print $2 }'

# 出力
# 2
```

### ファイルからスクリプトを読み込む
`-f`で外部のファイルからスクリプトを読み込むことができる。
```bash
# script.txtの中身
{ print $2 }
```

```bash
echo "1:2,3:4" | awk -F '[:,]' -f script.txt

# 出力
# 2
```

### 変数を外部から定義する
`-v`でスクリプト外から変数を定義することができる。  
シェルスクリプト内で定義した変数をawkに持ち込みたい場合などに有効。

```bash
# 変数「myname」を定義
echo "Hello" | awk -v myname="hoge" '{ print $0 ", " myname }'

# 出力
# Hello, hoge
```

# スクリプト
## レコードとフィールド
awkは入力されたテキストやファイルを基本的に行単位で読み込む。  
読み込まれたテキストは「レコード」や「フィールド」といった単位で取得可能。

* レコード ... 読み込んだ1行分のテキスト
  - `$0`でレコードの内容を取得できる
* フィールド ... `-F`によってレコード内でさらに分割されたテキスト1つ分
  - `$1, $2, $3 ...`でそれぞれのフィールドの内容を取得できる

## パターンとアクション
スクリプトでは「パターン」とそれに紐づく「アクション」を定義していく。  

* パターン ... テキストがアクションを行う条件を指定する
  - 正規表現や数値の比較などが可能
* アクション ... パターンに当てはまった場合に実際に行う処理

基本の文法は下記のような形で、パターンが増えるごとにこれを追加していく。
```bash
[パターン] { [アクション] }
[パターン] { [アクション] }
[パターン] { [アクション] }
...
```

パターンを指定しなかった場合、読み込んだ全ての行でそのアクションが実行される。
```bash
# 読み込んだレコードをそのまま表示
{ print $0 }
```

### パターン指定例
```bash
# 入力テキスト(test.txt)
# hoge1
# foi
# bartest
# hoge2
# fooa
# foob

# 正規表現でパターン指定
cat "test.txt" | awk '
/hoge/ { print "hoge!" }
/foo/  { print "foo!" }
/bar/  { print "bar!" }'

# 出力
# hoge!
# bar!
# hoge!
# foo!
# foo!
```

### 最初と最後に実行するアクション
パターンに`BEGIN`や`END`を指定すると、  
読み込みの最初と最後にそれぞれアクションを実行できる。
```bash
echo "hoge" | awk '
BEGIN { print "begin" }
{ print $0 }
END  { print "end" }'

# 出力
# begin
# hoge
# end
```
## 組み込み変数
awkにはあらかじめ定義されている変数があり、スクリプト内で使用可能。

### NF,NR
* `NF` ... 現在処理しているレコードのフィールド数を表す
* `NR` ... 読み込んだテキストのレコード数を表す

```bash
echo "5:6,7:8" | awk -F '[:,]' '{ print NF, NR }'
# 出力
4 1

# NFに$をつけると「レコードのフィールド数」番目のフィールド（つまり最後尾のフィールド）を取得できる
echo "5:6,7:8" | awk -F '[:,]' '{ print $NF }'
# 出力
8
```


## 演算
スクリプト内で四則演算が可能。
```bash
echo "10,20,30" | awk -F ',' '{ print $1 + $2 + $3 }'
# 出力
60
```

## 変数の使用
スクリプト内で変数を定義できる。  
これを利用して集計などが可能。
```bash
# 入力テキスト(test.txt)
# 10
# 20
# 30

cat "test.txt" | awk -F ',' '
BEGIN { sum = 0 }
{ sum = sum + $1 }
END { print sum }'

# 出力
# 60
```

## 条件式
条件式による分岐も可能。  
パターンに記述することで、特定のフィールドの値に応じた集計もできる。
```bash
# 入力テキスト(test.txt)
# hoge,10
# hoge,20
# fuga,25
# fuga,70
# hoge,5

# hogeの行だけを集計
cat "test.txt" | awk -F ',' '
BEGIN { sum = 0 }
$1 == "hoge" { sum = sum + $1 }
END { print sum }'

# 出力
# 35
```


## 参考
<https://qiita.com/tofu511/items/3ecf9c5361d08b5c6eae>  
<https://qiita.com/hnishi/items/4ee60ed515470e796f41>